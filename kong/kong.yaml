_format_version: "3.0"

services:
  - name: lunar-backend
    host: host.docker.internal
    port: 5872
    protocol: http
    routes:
      - name: backend-api
        paths:
          - /api
        strip_path: false
        plugins:
          - name: pre-function
            config:
              access:
                - |
                  -- Extract Bearer token and set as apikey for key-auth plugin
                  local auth_header = ngx.var.http_authorization
                  if auth_header and string.match(auth_header, "^Bearer%s+") then
                    local bearer_token = string.match(auth_header, "^Bearer%s+(.+)$")
                    if bearer_token then
                      ngx.req.set_header("apikey", bearer_token)
                    end
                  end
          - name: key-auth
            config:
              key_names:
                - apikey
                - Authorization
              key_in_header: true
              key_in_query: true
              hide_credentials: false

  - name: lunar-backend-admin
    url: ${BACKEND_URL}
    routes:
      - name: admin-api
        paths:
          - ~/admin(/api/.*)$
        strip_path: false
        preserve_host: false
        protocols:
          - http
          - https
        plugins:
          - name: basic-auth
            config:
              hide_credentials: true
          - name: request-transformer
            config:
              replace:
                uri: $(uri_captures[1])
      - name: admin-dashboard
        paths:
          - /admin
        strip_path: true
        preserve_host: false
        protocols:
          - http
          - https
        plugins:
          - name: basic-auth
            config:
              hide_credentials: true
      - name: landing-page
        paths:
          - /
        strip_path: false
        preserve_host: false
        protocols:
          - http
          - https
        plugins:
          - name: request-transformer
            config:
              replace:
                uri: /api/info

  - name: llm-service
    url: http://localhost:32000
    connect_timeout: 1800000  # 30 minutes (1,800,000 ms)
    write_timeout: 1800000    # 30 minutes
    read_timeout: 1800000     # 30 minutes
    routes:
      - name: llm-proxy
        paths:
          - /llm
        strip_path: true
        preserve_host: false
        protocols:
          - http
          - https
        plugins:
          - name: cors
            config:
              origins:
                - "*"
              methods:
                - GET
                - POST
                - OPTIONS
              headers:
                - Accept
                - Content-Type
                - apikey
                - Authorization
              exposed_headers:
                - X-Auth-Token
              credentials: true
              max_age: 3600
          - name: pre-function
            config:
              access:
                - |
                  -- Extract Bearer token and set as apikey for key-auth plugin
                  local auth_header = ngx.var.http_authorization
                  if auth_header and string.match(auth_header, "^Bearer%s+") then
                    local bearer_token = string.match(auth_header, "^Bearer%s+(.+)$")
                    if bearer_token then
                      ngx.req.set_header("apikey", bearer_token)
                    end
                  end
          - name: key-auth
            config:
              key_names:
                - apikey
                - Authorization
              key_in_header: true
              key_in_query: true
              hide_credentials: false
          - name: lunar-gateway
            config:
              backend_url: ${BACKEND_URL}
          - name: ai-proxy
            config:
              route_type: llm/v1/chat
              auth:
                header_name: Authorization
                header_value: "Bearer ${OPENAI_API_KEY}"
              model:
                provider: openai
                name: gpt-5
                options:
                  temperature: 1.0
                  max_tokens: null  # Kong 3.9.1+ treats null correctly (no limit)
              max_request_body_size: 1048576  # 1MB limit for large requests (Dyad sends full codebase)

  - name: ollama-service
    url: ${OLLAMA_BACKEND_URL}
    connect_timeout: 1800000  # 30 minutes (1,800,000 ms)
    write_timeout: 1800000    # 30 minutes
    read_timeout: 1800000     # 30 minutes
    routes:
      - name: ollama-proxy
        paths:
          - ~/local-llm(/v1/chat/.*)$
        strip_path: false
        preserve_host: false
        protocols:
          - http
          - https
        methods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        plugins:
          - name: pre-function
            config:
              access:
                - |
                  -- Extract Bearer token and set as apikey for key-auth plugin
                  local auth_header = ngx.var.http_authorization
                  if auth_header and string.match(auth_header, "^Bearer%s+") then
                    local bearer_token = string.match(auth_header, "^Bearer%s+(.+)$")
                    if bearer_token then
                      ngx.req.set_header("apikey", bearer_token)
                    end
                  end
          - name: request-transformer
            config:
              replace:
                uri: $(uri_captures[1])
          - name: key-auth
            config:
              key_names:
                - apikey
                - Authorization
              key_in_header: true
              key_in_query: true
              hide_credentials: false
          - name: response-transformer
            config:
              add:
                headers:
                  - X-Kong-LLM-Model:ollama/${OLLAMA_MODEL_NAME}
          - name: lunar-gateway
            config:
              backend_url: ${BACKEND_URL}
